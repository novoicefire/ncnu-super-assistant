name: Weekly Sync Course Data

on:
  schedule:
    # æ¯é€±æ—¥ 18:00 UTC åŸ·è¡Œ (å°ç£æ™‚é–“é€±ä¸€å‡Œæ™¨ 2:00)
    - cron: '0 18 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check if should run
        id: check_date
        run: |
          CURRENT_MONTH=$(date +%m | sed 's/^0*//')
          echo "Current month: $CURRENT_MONTH"
          
          # åœæ­¢æ›´æ–°çš„æœˆä»½ï¼š10-12æœˆå’Œ3-6æœˆ
          if [[ $CURRENT_MONTH -ge 10 ]] || [[ $CURRENT_MONTH -ge 3 && $CURRENT_MONTH -le 6 ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "ğŸš« ç•¶å‰æœˆä»½ ($CURRENT_MONTH) åœ¨åœæ­¢æ›´æ–°æœŸé–“ï¼Œè·³éåŸ·è¡Œ"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "âœ… ç•¶å‰æœˆä»½ ($CURRENT_MONTH) å…è¨±æ›´æ–°"
          fi

      - name: Checkout repository
        if: steps.check_date.outputs.should_skip == 'false'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.check_date.outputs.should_skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        if: steps.check_date.outputs.should_skip == 'false'
        run: pip install requests

      - name: Fetch course data from NCNU API
        if: steps.check_date.outputs.should_skip == 'false'
        run: python scripts/fetch_course_data.py

      - name: Commit and push unconditionally
        if: steps.check_date.outputs.should_skip == 'false'
        run: |
          FILE="frontend/public/data/æœ¬å­¸æœŸé–‹èª²è³‡è¨ŠAPI.json"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global core.quotepath false

          git add "$FILE"
          git commit -m "Data: é€±æœŸæ€§åŒæ­¥èª²ç¨‹è³‡æ–™ ($(date '+%Y-%m-%d %H:%M'))"
          git push
          echo "âœ” èª²ç¨‹è³‡æ–™å·²æ›´æ–°ä¸¦æ¨é€åˆ°å€‰åº«ï¼"

      - name: Skip notification
        if: steps.check_date.outputs.should_skip == 'true'
        run: |
          echo "ğŸ”„ å·¥ä½œæµç¨‹å·²è·³éï¼Œå°‡æ–¼ä¸‹æ¬¡å…è¨±çš„æ™‚é–“é»åŸ·è¡Œ"
          echo "ğŸ“… åŸ·è¡Œæœˆä»½ï¼š1-2æœˆã€7-9æœˆ"
          echo "ğŸš« åœæ­¢æœˆä»½ï¼š3-6æœˆã€10-12æœˆ"
