name: Weekly Sync Course Data

on:
  schedule:
    - cron: '0 18 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check if should run
        id: check_date
        run: |
          CURRENT_MONTH=$(date +%m | sed 's/^0*//')
          echo "Current month: $CURRENT_MONTH"
          
          if [[ $CURRENT_MONTH -ge 10 ]] || [[ $CURRENT_MONTH -ge 3 && $CURRENT_MONTH -le 6 ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "ğŸš« ç•¶å‰æœˆä»½ ($CURRENT_MONTH) åœ¨åœæ­¢æ›´æ–°æœŸé–“ï¼Œè·³éåŸ·è¡Œ"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "âœ… ç•¶å‰æœˆä»½ ($CURRENT_MONTH) å…è¨±æ›´æ–°"
          fi

      - name: Checkout main branch
        if: steps.check_date.outputs.should_skip == 'false'
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        if: steps.check_date.outputs.should_skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        if: steps.check_date.outputs.should_skip == 'false'
        run: pip install requests

      - name: Fetch course data from NCNU API
        if: steps.check_date.outputs.should_skip == 'false'
        run: python scripts/fetch_course_data.py

      - name: Commit and push to main
        if: steps.check_date.outputs.should_skip == 'false'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global core.quotepath false

          FILE="frontend/public/data/æœ¬å­¸æœŸé–‹èª²è³‡è¨ŠAPI.json"
          git add "$FILE"
          git commit -m "Data: é€±æœŸæ€§åŒæ­¥èª²ç¨‹è³‡æ–™ ($(date '+%Y-%m-%d %H:%M'))"
          git push origin main
          echo "âœ” main åˆ†æ”¯è³‡æ–™å·²æ›´æ–°ï¼"

      - name: Update develop branch
        if: steps.check_date.outputs.should_skip == 'false'
        run: |
          # åˆ‡æ›åˆ° develop åˆ†æ”¯
          git fetch origin develop
          git checkout develop
          
          # è¤‡è£½æ›´æ–°çš„æª”æ¡ˆåˆ° develop åˆ†æ”¯
          git checkout main -- "frontend/public/data/æœ¬å­¸æœŸé–‹èª²è³‡è¨ŠAPI.json"
          
          # æäº¤åˆ° develop åˆ†æ”¯
          git add "frontend/public/data/æœ¬å­¸æœŸé–‹èª²è³‡è¨ŠAPI.json"
          git commit -m "Data: åŒæ­¥èª²ç¨‹è³‡æ–™åˆ° develop åˆ†æ”¯ ($(date '+%Y-%m-%d %H:%M'))"
          git push origin develop
          echo "âœ” develop åˆ†æ”¯è³‡æ–™å·²åŒæ­¥ï¼"

      - name: Skip notification
        if: steps.check_date.outputs.should_skip == 'true'
        run: |
          echo "ğŸ”„ å·¥ä½œæµç¨‹å·²è·³éï¼Œå°‡æ–¼ä¸‹æ¬¡å…è¨±çš„æ™‚é–“é»åŸ·è¡Œ"
