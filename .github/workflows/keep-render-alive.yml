name: Keep Render Alive

on:
  schedule:
    - cron: '*/10 23 * * *'      # UTC 23:00-23:59 â†’ å°ç£ 07:00-07:59
    - cron: '*/10 0-18 * * *'    # UTC 00:00-18:59 â†’ å°ç£ 08:00-02:59
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-time:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.time_check.outputs.should_run }}
      current_time: ${{ steps.time_check.outputs.current_time }}
    steps:
      - name: Check Taiwan Time
        id: time_check
        run: |
          current_hour=$(TZ='Asia/Taipei' date +'%H')
          current_time=$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')
          echo "ç•¶å‰å°ç£æ™‚é–“: $current_time"
          echo "ç•¶å‰å°æ™‚: $current_hour"
          echo "current_time=$current_time" >> $GITHUB_OUTPUT
          
          if [ "$current_hour" -ge 7 ] || [ "$current_hour" -lt 3 ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  ping-render:
    runs-on: ubuntu-latest
    needs: check-time
    if: needs.check-time.outputs.should_run == 'true'
    steps:
      - name: Ping Render Service
        id: ping
        run: |
          echo "æ­£åœ¨å–šé†’ Render æœå‹™..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            https://ncnu-assistant-backend.onrender.com)
          
          if [ "$response" -eq 200 ]; then
            echo "âœ… æœå‹™æ­£å¸¸é‹è¡Œ (HTTP $response)"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "response_code=$response" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœå‹™å›æ‡‰ç•°å¸¸ (HTTP $response)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "response_code=$response" >> $GITHUB_OUTPUT
          fi
      
      # ä½¿ç”¨ curl ç›´æ¥ç™¼é€ Discord é€šçŸ¥ï¼ˆæœ€å¯é çš„æ–¹å¼ï¼‰
      - name: Send Discord Alert
        if: always() && steps.ping.outputs.status == 'failed'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸš¨ Render æœå‹™ç•°å¸¸è­¦å ±",
                "description": "æœå‹™ç„¡æ³•æ­£å¸¸å›æ‡‰ï¼Œè«‹ç«‹å³æª¢æŸ¥ï¼",
                "color": 16711680,
                "fields": [
                  {
                    "name": "HTTP ç‹€æ…‹ç¢¼",
                    "value": "`${{ steps.ping.outputs.response_code }}`",
                    "inline": true
                  },
                  {
                    "name": "å€‰åº«",
                    "value": "`${{ github.repository }}`",
                    "inline": true
                  },
                  {
                    "name": "è§¸ç™¼æ™‚é–“",
                    "value": "${{ needs.check-time.outputs.current_time }} (å°ç£æ™‚é–“)",
                    "inline": false
                  },
                  {
                    "name": "åŸ·è¡Œè¨˜éŒ„",
                    "value": "[é»æ“ŠæŸ¥çœ‹è©³æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Workflow: ${{ github.workflow }}"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }],
              "username": "Render ç›£æ§æ©Ÿå™¨äºº",
              "avatar_url": "https://avatars.githubusercontent.com/u/44036562?s=200&v=4"
            }'
          
          if [ $? -eq 0 ]; then
            echo "âœ… Discord é€šçŸ¥å·²ç™¼é€"
          else
            echo "âŒ Discord é€šçŸ¥ç™¼é€å¤±æ•—"
            exit 1
          fi
