name: Keep Render Alive

on:
  schedule:
    # æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼Œå°æ‡‰å°ç£æ™‚é–“ 07:00-23:59
    - cron: '*/5 23 * * *'      # UTC 23:00-23:55 â†’ å°ç£ 07:00-07:55
    - cron: '*/5 0-15 * * *'    # UTC 00:00-15:55 â†’ å°ç£ 08:00-23:55
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-time:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.time_check.outputs.should_run }}
      current_time: ${{ steps.time_check.outputs.current_time }}
    steps:
      - name: Check Taiwan Time
        id: time_check
        run: |
          current_hour=$(TZ='Asia/Taipei' date +'%H')
          current_time=$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M:%S')
          echo "ç•¶å‰å°ç£æ™‚é–“: $current_time"
          echo "ç•¶å‰å°æ™‚: $current_hour"
          echo "current_time=$current_time" >> $GITHUB_OUTPUT
          
          # å°ç£æ™‚é–“ 07:00-23:59 åŸ·è¡Œï¼ˆæ’é™¤ 00:00-06:59ï¼‰
          if [ "$current_hour" -ge 7 ]; then
            echo "âœ… åœ¨åŸ·è¡Œæ™‚æ®µå…§ (07:00-23:59)ï¼Œç¹¼çºŒåŸ·è¡Œ"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ’¤ åœ¨ä¼‘çœ æ™‚æ®µ (00:00-06:59)ï¼Œè·³éåŸ·è¡Œ"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  ping-render:
    runs-on: ubuntu-latest
    needs: check-time
    if: needs.check-time.outputs.should_run == 'true'
    steps:
      - name: Ping Render Service
        id: ping
        run: |
          echo "ğŸ”„ æ­£åœ¨å–šé†’ Render æœå‹™ (5 åˆ†é˜é–“éš”ç¢ºä¿ä¸ä¼‘çœ )..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 45 \
            --connect-timeout 20 \
            https://ncnu-assistant-backend.onrender.com)
          
          curl_exit_code=$?
          
          if [ $curl_exit_code -eq 0 ]; then
            if [ "$response" -eq 200 ]; then
              echo "âœ… æœå‹™æ­£å¸¸é‹è¡Œ (HTTP $response)"
              echo "status=success" >> $GITHUB_OUTPUT
              echo "response_code=$response" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ æœå‹™å›æ‡‰ç•°å¸¸ (HTTP $response)"
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "response_code=$response" >> $GITHUB_OUTPUT
              echo "error_type=http_error" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ é€£ç·šå¤±æ•— (curl exit code: $curl_exit_code)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "response_code=curl_error_$curl_exit_code" >> $GITHUB_OUTPUT
            
            if [ $curl_exit_code -eq 28 ]; then
              echo "error_type=timeout" >> $GITHUB_OUTPUT
            else
              echo "error_type=connection_error" >> $GITHUB_OUTPUT
            fi
          fi
      
      # ç™¼é€ Discord é€šçŸ¥
      - name: Send Discord Alert
        if: always() && steps.ping.outputs.status == 'failed' && steps.ping.outputs.error_type != 'timeout'
        run: |
          ERROR_MSG="æœå‹™ç•°å¸¸"
          case "${{ steps.ping.outputs.error_type }}" in
            "http_error")
              ERROR_MSG="HTTP ç‹€æ…‹ç¢¼ç•°å¸¸"
              ;;
            "connection_error")
              ERROR_MSG="ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨"
              ;;
          esac
          
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸš¨ Render æœå‹™ç•°å¸¸è­¦å ±",
                "description": "'"$ERROR_MSG"'",
                "color": 16711680,
                "fields": [
                  {
                    "name": "ç‹€æ…‹",
                    "value": "`${{ steps.ping.outputs.response_code }}`",
                    "inline": true
                  },
                  {
                    "name": "æ™‚é–“",
                    "value": "${{ needs.check-time.outputs.current_time }}",
                    "inline": true
                  },
                  {
                    "name": "åŸ·è¡Œè¨˜éŒ„",
                    "value": "[æŸ¥çœ‹è©³æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }],
              "username": "Render ç›£æ§æ©Ÿå™¨äºº"
            }'
