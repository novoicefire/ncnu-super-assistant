name: Keep Render Alive

on:
  schedule:
    # æ¯ 10 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼Œåƒ…åœ¨å°ç£ç™½å¤©æ™‚æ®µ
    - cron: '*/10 23 * * *'      # UTC 23:00-23:59 â†’ å°ç£ 07:00-07:59
    - cron: '*/10 0-18 * * *'    # UTC 00:00-18:59 â†’ å°ç£ 08:00-02:59
  
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  # æª¢æŸ¥æ˜¯å¦åœ¨å°ç£ç™½å¤©æ™‚æ®µ
  check-time:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.time_check.outputs.should_run }}
    steps:
      - name: Check Taiwan Time
        id: time_check
        run: |
          current_hour=$(TZ='Asia/Taipei' date +'%H')
          echo "ç•¶å‰å°ç£æ™‚é–“: $(TZ='Asia/Taipei' date)"
          echo "ç•¶å‰å°æ™‚: $current_hour"
          
          if [ "$current_hour" -ge 7 ] || [ "$current_hour" -lt 3 ]; then
            echo "åœ¨åŸ·è¡Œæ™‚æ®µå…§ï¼Œç¹¼çºŒåŸ·è¡Œ"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "åœ¨ä¼‘çœ æ™‚æ®µ(03:00-06:59)ï¼Œè·³éåŸ·è¡Œ"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # å–šé†’ Render æœå‹™
  ping-render:
    runs-on: ubuntu-latest
    needs: check-time
    if: needs.check-time.outputs.should_run == 'true'
    steps:
      - name: Ping Render Service
        id: ping
        continue-on-error: true
        run: |
          echo "æ­£åœ¨å–šé†’ Render æœå‹™..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            https://wrong-url-for-testing.onrender.com/ping)
          
          if [ "$response" -eq 200 ]; then
            echo "âœ… æœå‹™æ­£å¸¸é‹è¡Œ (HTTP $response)"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âš ï¸ æœå‹™å›æ‡‰ç•°å¸¸ (HTTP $response)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "response_code=$response" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      # ç™¼é€ Discord é€šçŸ¥ï¼ˆåƒ…åœ¨å¤±æ•—æ™‚ï¼‰
      - name: Send Discord Alert on Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'Failure'
          title: 'ğŸš¨ Render æœå‹™ç•°å¸¸è­¦å ±'
          description: |
            **æœå‹™ç„¡æ³•æ­£å¸¸å›æ‡‰**
            
            **HTTP ç‹€æ…‹ç¢¼**: `${{ steps.ping.outputs.response_code }}`
            **æ™‚é–“**: ${{ github.event.head_commit.timestamp }}
            **å€‰åº«**: `${{ github.repository }}`
          color: 0xff0000
          username: Render ç›£æ§æ©Ÿå™¨äºº
          avatar_url: https://avatars.githubusercontent.com/u/44036562?s=200&v=4
      
      # æ¯å¤©æ—©ä¸Š 8 é»ç™¼é€æˆåŠŸæ‘˜è¦ï¼ˆå¯é¸ï¼‰
      - name: Send Daily Summary
        if: success() && github.event.schedule == '0 0 * * *'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: 'Success'
          title: 'âœ… Render æœå‹™é‹è¡Œæ­£å¸¸'
          description: |
            **æœå‹™ç‹€æ…‹**: æ­£å¸¸é‹è¡Œ
            **ç›£æ§é€±æœŸ**: éå» 24 å°æ™‚
            **å€‰åº«**: `${{ github.repository }}`
          color: 0x00ff00
          username: Render ç›£æ§æ©Ÿå™¨äºº
          nodetail: true

  # é˜²æ­¢ Workflow å¤±æ•ˆ
  keep-workflow-alive:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check and Create Keepalive Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          last_commit_date=$(git log -1 --format=%ct)
          current_date=$(date +%s)
          days_since_commit=$(( ($current_date - $last_commit_date) / 86400 ))
          
          echo "ğŸ“… è·é›¢ä¸Šæ¬¡æäº¤: $days_since_commit å¤©"
          
          if [ $days_since_commit -gt 50 ]; then
            echo "âš ï¸ è¶…é 50 å¤©æœªæäº¤ï¼Œå»ºç«‹ keepalive commit"
            git commit --allow-empty -m "chore: keepalive [skip ci]"
            git push
            echo "âœ… Keepalive commit å·²æ¨é€"
          else
            echo "âœ… ç„¡éœ€ keepalive commit"
          fi
